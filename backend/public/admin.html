<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Administration - Pr√©sences du jour</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            text-align: center;
        }

        .header h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 2rem;
        }

        .loading {
            text-align: center;
            padding: 40px;
            font-size: 1.2rem;
            color: #666;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 350px;
            gap: 20px;
        }

        .left-panel {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        .right-panel {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .panel {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        .date-selector {
            margin-bottom: 20px;
        }

        .date-selector input[type="date"] {
            padding: 10px 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
            width: 200px;
            margin-right: 10px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s;
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-success {
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
        }

        .btn-warning {
            background: linear-gradient(135deg, #ff9500, #ff8c00);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(135deg, #ff6b6b, #ff5252);
            color: white;
        }

        .btn-small {
            padding: 5px 10px;
            font-size: 0.9rem;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            text-align: center;
            padding: 15px;
            border-radius: 10px;
            color: white;
        }

        .stat-card h3 {
            font-size: 2rem;
            margin-bottom: 5px;
        }

        .stat-card p {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .stat-total { background: linear-gradient(135deg, #667eea, #764ba2); }
        .stat-adherents { background: linear-gradient(135deg, #4CAF50, #45a049); }
        .stat-nonmembers { background: linear-gradient(135deg, #2196F3, #1976D2); }
        .stat-revenue { background: linear-gradient(135deg, #9C27B0, #7B1FA2); }

        .table-container {
            overflow-x: auto;
            margin: 20px 0;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        th {
            background: #f8f9fa;
            padding: 12px 8px;
            text-align: left;
            font-weight: 600;
            border-bottom: 2px solid #dee2e6;
            font-size: 0.9rem;
        }

        td {
            padding: 10px 8px;
            border-bottom: 1px solid #eee;
            vertical-align: middle;
            font-size: 0.9rem;
        }

        tr:nth-child(even) {
            background-color: #f8f9fa;
        }

        tr:hover {
            background-color: #e3f2fd;
        }

        .type-badge {
            padding: 4px 8px;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: 600;
            color: white;
            text-align: center;
            display: inline-block;
            min-width: 80px;
        }

        .type-adherent {
            background: linear-gradient(135deg, #4CAF50, #45a049);
        }

        .type-non-adherent {
            background: linear-gradient(135deg, #2196F3, #1976D2);
        }

        .status-badge {
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            color: white;
        }

        .status-paye { background: #4CAF50; }
        .status-pending { background: #ff9500; }
        .status-adherent { background: #2196F3; }

        .no-data {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .no-data h3 {
            margin-bottom: 10px;
            color: #999;
        }

        .export-section {
            margin-top: 20px;
        }

        .export-section h4 {
            margin-bottom: 15px;
            color: #333;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #333;
        }

        .form-group select {
            width: 100%;
            padding: 8px 12px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 1rem;
        }

        .info-box {
            background: #e3f2fd;
            border: 1px solid #2196F3;
            border-radius: 6px;
            padding: 10px;
            margin: 10px 0;
            font-size: 0.9rem;
            color: #1976D2;
        }

        .warning-box {
            background: #fff3e0;
            border: 1px solid #ff9500;
            border-radius: 6px;
            padding: 10px;
            margin: 10px 0;
            font-size: 0.9rem;
            color: #f57c00;
        }

        .debug-info {
            background: #f5f5f5;
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 10px;
            font-family: monospace;
            font-size: 0.8rem;
            margin-bottom: 20px;
        }

        .historical-mode {
            background: #fff3e0;
            border: 1px solid #ff9500;
            border-radius: 6px;
            padding: 10px;
            margin-bottom: 20px;
            text-align: center;
            color: #f57c00;
            font-weight: 600;
        }

        .refresh-info {
            background: #e8f5e8;
            border: 1px solid #4CAF50;
            border-radius: 6px;
            padding: 10px;
            margin: 10px 0;
            font-size: 0.9rem;
            color: #2e7d32;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        @media (max-width: 1200px) {
            .main-content {
                grid-template-columns: 1fr;
            }

            .stats-grid {
                grid-template-columns: repeat(4, 1fr);
            }
        }

        @media (max-width: 768px) {
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .container {
                padding: 10px;
            }

            th, td {
                padding: 6px 4px;
                font-size: 0.8rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìä Administration - Pr√©sences du jour</h1>
            <div class="loading" id="loading">Chargement...</div>
        </div>

        <div id="content" style="display: none;">
            <div class="main-content">
                <div class="left-panel">
                    <div class="debug-info">
                        <strong>üîß Debug Info:</strong>
                        <div id="debug-info">Loading...</div>
                    </div>

                    <div class="date-selector">
                        <label>S√©lectionner une date:</label>
                        <input type="date" id="date-picker" />
                        <button class="btn btn-primary" onclick="loadToday()">Aujourd'hui</button>
                        <button class="btn btn-primary" onclick="loadSelectedDate()">Charger</button>
                        <button class="btn btn-warning" onclick="archiveToday()">üì¶ Archiver aujourd'hui</button>
                    </div>

                    <div id="historical-mode" class="historical-mode" style="display: none;">
                        üìÖ Mode historique - Les donn√©es sont en lecture seule
                    </div>

                    <div class="stats-grid">
                        <div class="stat-card stat-total">
                            <h3 id="stat-total">0</h3>
                            <p>Total pr√©sences</p>
                        </div>
                        <div class="stat-card stat-adherents">
                            <h3 id="stat-adherents">0</h3>
                            <p>Adh√©rents</p>
                        </div>
                        <div class="stat-card stat-nonmembers">
                            <h3 id="stat-nonmembers">0</h3>
                            <p>Non-adh√©rents</p>
                        </div>
                        <div class="stat-card stat-revenue">
                            <h3 id="stat-revenue">0</h3>
                            <p>Recettes (‚Ç¨)</p>
                        </div>
                    </div>

                    <div class="table-container">
                        <div id="table-loading" class="loading">Chargement...</div>
                        <table id="presences-table" style="display: none;">
                            <thead>
                                <tr>
                                    <th>Date/Heure</th>
                                    <th>Type</th>
                                    <th>Nom</th>
                                    <th>Pr√©nom</th>
                                    <th>Niveau</th>
                                    <th>Tarif</th>
                                    <th>Paiement</th>
                                    <th>Statut</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="presences-tbody">
                            </tbody>
                        </table>

                        <div id="no-data" class="no-data" style="display: none;">
                            <h3>Aucune pr√©sence pour cette date</h3>
                            <p>Les pr√©sences appara√Ætront ici au fur et √† mesure des arriv√©es.</p>
                        </div>
                    </div>

                    <div class="refresh-info">
                        üîÑ <span>Actualisation automatique toutes les 30 secondes</span>
                    </div>
                </div>

                <div class="right-panel">
                    <div class="panel export-section">
                        <h4>üèîÔ∏è Export Saison Actuelle (1 juillet - 30 juin)</h4>
                        <button class="btn btn-success" onclick="exportSeason()" style="width: 100%; margin-bottom: 10px;">
                            üìä Exporter Saison Courante
                        </button>
                        <div class="info-box">
                            üìÖ Export automatique: 30 juin √† minuit
                        </div>
                        <div class="info-box">
                            <strong>‚ÑπÔ∏è Info:</strong> Cette fonction met √† jour le fichier Excel de la saison en cours avec toutes les donn√©es actuelles.
                        </div>
                    </div>

                    <div class="panel export-section">
                        <h4>üìä Export Excel Historique (par ann√©e civile)</h4>
                        <div class="form-group">
                            <label for="year-select">S√©lectionner une ann√©e pour l'export :</label>
                            <select id="year-select">
                                <option value="">S√©lectionner une ann√©e pour l'export...</option>
                            </select>
                        </div>
                        <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                            <button class="btn btn-primary" onclick="exportYear()" style="flex: 1;">
                                üì• Exporter
                            </button>
                            <button class="btn btn-danger" onclick="exportAndCleanup()" style="flex: 1;">
                                üóëÔ∏è Export & Nettoyage
                            </button>
                        </div>
                        <div class="warning-box">
                            <strong>‚ö†Ô∏è Attention :</strong> "Export & Nettoyage" supprime d√©finitivement toutes les donn√©es de l'ann√©e s√©lectionn√©e apr√®s avoir cr√©√© l'export Excel. Cette action ne peut pas √™tre annul√©e !
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ‚úÖ GECORRIGEERDE API BASE URL - WAS 4000, NU 3001
        const API_BASE_URL = 'http://localhost:3001';

        let isHistoricalMode = false;
        let currentDate = '';

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('date-picker').value = today;
            currentDate = today;

            loadToday();
            loadAvailableYears();

            // Auto refresh every 30 seconds for current day only
            setInterval(() => {
                if (!isHistoricalMode) {
                    loadPresences();
                }
            }, 30000);

            updateDebugInfo();
        });

        function updateDebugInfo() {
            const debugInfo = document.getElementById('debug-info');
            debugInfo.innerHTML = `
                API URL: ${API_BASE_URL}<br>
                Current Date: ${currentDate}<br>
                Historical Mode: ${isHistoricalMode ? 'Yes' : 'No'}<br>
                Last Update: ${new Date().toLocaleTimeString()}
            `;
        }

        async function loadToday() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('date-picker').value = today;
            currentDate = today;
            isHistoricalMode = false;

            document.getElementById('historical-mode').style.display = 'none';
            await loadPresences();
            updateDebugInfo();
        }

        async function loadSelectedDate() {
            const selectedDate = document.getElementById('date-picker').value;
            if (!selectedDate) {
                alert('Veuillez s√©lectionner une date');
                return;
            }

            currentDate = selectedDate;
            const today = new Date().toISOString().split('T')[0];
            isHistoricalMode = selectedDate !== today;

            document.getElementById('historical-mode').style.display = 
                isHistoricalMode ? 'block' : 'none';

            await loadPresences();
            updateDebugInfo();
        }

        async function loadPresences() {
            try {
                showLoading();

                let response;
                if (isHistoricalMode) {
                    response = await fetch(`${API_BASE_URL}/presences/history/${currentDate}`);
                } else {
                    response = await fetch(`${API_BASE_URL}/presences`);
                }

                const data = await response.json();

                if (data.success) {
                    let presences = data.presences || [];

                    // Filter for current date if viewing today
                    if (!isHistoricalMode) {
                        presences = presences.filter(p => 
                            p.date && p.date.startsWith(currentDate)
                        );
                    }

                    displayPresences(presences);
                    updateStats(presences);
                } else {
                    console.error('Error loading presences:', data.error);
                    displayPresences([]);
                }

                hideLoading();

            } catch (error) {
                console.error('Network error:', error);
                hideLoading();
                displayPresences([]);
            }
        }

        function displayPresences(presences) {
            const tbody = document.getElementById('presences-tbody');
            const table = document.getElementById('presences-table');
            const noData = document.getElementById('no-data');

            tbody.innerHTML = '';

            if (presences.length === 0) {
                table.style.display = 'none';
                noData.style.display = 'block';
                return;
            }

            table.style.display = 'table';
            noData.style.display = 'none';

            presences.forEach(presence => {
                const row = document.createElement('tr');

                const formatDateTime = (dateString) => {
                    if (!dateString) return '-';
                    const date = new Date(dateString);
                    return date.toLocaleString('fr-FR', {
                        day: '2-digit',
                        month: '2-digit',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                };

                const getTypeBadge = (type) => {
                    return type === 'adherent' 
                        ? '<span class="type-badge type-adherent">üë§ Adh√©rent</span>'
                        : '<span class="type-badge type-non-adherent">üéØ Visiteur</span>';
                };

                const getStatusBadge = (status) => {
                    const statusClass = status === 'Pay√©' ? 'status-paye' 
                        : status === 'adherent' ? 'status-adherent' 
                        : 'status-pending';
                    return `<span class="status-badge ${statusClass}">${status || 'En attente'}</span>`;
                };

                const getTarif = (presence) => {
                    if (presence.tarif !== undefined) {
                        return presence.tarif === 0 ? 'Gratuit' : `${presence.tarif}‚Ç¨`;
                    }
                    return '-';
                };

                const getActions = (presence) => {
                    if (isHistoricalMode) {
                        return '<em>Mode historique</em>';
                    }

                    let actions = '';
                    if (presence.status !== 'Pay√©' && presence.type === 'non-adherent') {
                        actions += `<button class="btn btn-success btn-small" onclick="validatePresence('${presence.id}')">‚úì Valider</button> `;
                    }
                    actions += `<button class="btn btn-danger btn-small" onclick="deletePresence('${presence.id}')">üóëÔ∏è</button>`;
                    return actions;
                };

                row.innerHTML = `
                    <td>${formatDateTime(presence.date)}</td>
                    <td>${getTypeBadge(presence.type)}</td>
                    <td><strong>${presence.nom || ''}</strong></td>
                    <td>${presence.prenom || ''}</td>
                    <td>${presence.niveau || '-'}</td>
                    <td>${getTarif(presence)}</td>
                    <td>${presence.methodePaiement || '-'}</td>
                    <td>${getStatusBadge(presence.status)}</td>
                    <td>${getActions(presence)}</td>
                `;

                tbody.appendChild(row);
            });
        }

        function updateStats(presences) {
            const totalPresences = presences.length;
            const adherents = presences.filter(p => p.type === 'adherent').length;
            const nonAdherents = presences.filter(p => p.type === 'non-adherent').length;
            const revenue = presences
                .filter(p => p.tarif && typeof p.tarif === 'number')
                .reduce((sum, p) => sum + p.tarif, 0);

            document.getElementById('stat-total').textContent = totalPresences;
            document.getElementById('stat-adherents').textContent = adherents;
            document.getElementById('stat-nonmembers').textContent = nonAdherents;
            document.getElementById('stat-revenue').textContent = revenue;
        }

        async function validatePresence(id) {
            const montant = prompt('Montant √† valider (‚Ç¨):');
            if (montant === null) return;

            const methodePaiement = prompt('M√©thode de paiement:', 'Especes');
            if (methodePaiement === null) return;

            try {
                const response = await fetch(`${API_BASE_URL}/presences/${id}/valider`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        montant: parseFloat(montant) || 0,
                        methodePaiement: methodePaiement
                    })
                });

                const result = await response.json();
                if (result.success) {
                    alert('Pr√©sence valid√©e avec succ√®s');
                    await loadPresences();
                } else {
                    alert('Erreur: ' + result.error);
                }
            } catch (error) {
                alert('Erreur de connexion');
            }
        }

        async function deletePresence(id) {
            if (!confirm('√ätes-vous s√ªr de vouloir supprimer cette pr√©sence ?')) {
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/presences/${id}`, {
                    method: 'DELETE'
                });

                const result = await response.json();
                if (result.success) {
                    alert('Pr√©sence supprim√©e');
                    await loadPresences();
                } else {
                    alert('Erreur: ' + result.error);
                }
            } catch (error) {
                alert('Erreur de connexion');
            }
        }

        async function archiveToday() {
            if (!confirm('Archiver toutes les pr√©sences d\'aujourd\'hui et les effacer de la liste courante ?')) {
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/presences/archive`, {
                    method: 'POST'
                });

                const result = await response.json();
                if (result.success) {
                    alert(result.message);
                    await loadPresences();
                } else {
                    alert('Erreur: ' + (result.error || result.message));
                }
            } catch (error) {
                alert('Erreur de connexion');
            }
        }

        async function exportSeason() {
            try {
                const response = await fetch(`${API_BASE_URL}/admin/export/season`, {
                    method: 'POST'
                });

                const result = await response.json();
                if (result.success) {
                    alert(`Export r√©ussi: ${result.filename}\nRecords: ${result.recordCount}\nSaison: ${result.seasonName}`);
                } else {
                    alert('Erreur: ' + result.error);
                }
            } catch (error) {
                alert('Erreur de connexion');
            }
        }

        async function loadAvailableYears() {
            try {
                const response = await fetch(`${API_BASE_URL}/admin/export/years`);
                const result = await response.json();

                if (result.success) {
                    const select = document.getElementById('year-select');
                    select.innerHTML = '<option value="">S√©lectionner une ann√©e pour l\'export...</option>';

                    result.years.forEach(year => {
                        const option = document.createElement('option');
                        option.value = year;
                        option.textContent = year;
                        select.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Error loading years:', error);
            }
        }

        async function exportYear() {
            const year = document.getElementById('year-select').value;
            if (!year) {
                alert('Veuillez s√©lectionner une ann√©e');
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/admin/export/${year}`, {
                    method: 'POST'
                });

                const result = await response.json();
                if (result.success) {
                    alert(`Export r√©ussi: ${result.filename}\nRecords: ${result.recordCount}`);
                } else {
                    alert('Erreur: ' + result.error);
                }
            } catch (error) {
                alert('Erreur de connexion');
            }
        }

        async function exportAndCleanup() {
            const year = document.getElementById('year-select').value;
            if (!year) {
                alert('Veuillez s√©lectionner une ann√©e');
                return;
            }

            if (!confirm(`ATTENTION: Cette action va exporter l'ann√©e ${year} puis supprimer d√©finitivement toutes les donn√©es de cette ann√©e. Cette action ne peut pas √™tre annul√©e. Continuer ?`)) {
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/admin/export-and-cleanup/${year}`, {
                    method: 'POST'
                });

                const result = await response.json();
                if (result.success) {
                    alert(`Export et nettoyage r√©ussis:\nFichier: ${result.export.filename}\nRecords export√©s: ${result.export.recordCount}\nRecords supprim√©s: ${result.cleanup.deletedCount}`);
                    await loadAvailableYears(); // Refresh the year list
                } else {
                    alert('Erreur: ' + result.error);
                }
            } catch (error) {
                alert('Erreur de connexion');
            }
        }

        function showLoading() {
            document.getElementById('loading').style.display = 'block';
            document.getElementById('content').style.display = 'none';
        }

        function hideLoading() {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('content').style.display = 'block';
        }
    </script>
</body>
</html>
