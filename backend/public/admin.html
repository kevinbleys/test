<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Administration - Pr√©sences du jour</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            text-align: center;
        }

        .header h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 2rem;
        }

        .loading {
            text-align: center;
            padding: 40px;
            font-size: 1.2rem;
            color: #666;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 350px;
            gap: 20px;
        }

        .left-panel {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        .right-panel {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .panel {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        .date-selector {
            margin-bottom: 20px;
        }

        .date-selector input[type="date"] {
            padding: 10px 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
            width: 200px;
            margin-right: 10px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s;
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-success {
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
        }

        .btn-warning {
            background: linear-gradient(135deg, #ff9500, #ff8c00);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(135deg, #ff6b6b, #ff5252);
            color: white;
        }

        .btn-small {
            padding: 5px 10px;
            font-size: 0.9rem;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            text-align: center;
            padding: 15px;
            border-radius: 10px;
            color: white;
        }

        .stat-card h3 {
            font-size: 2rem;
            margin-bottom: 5px;
        }

        .stat-card p {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .stat-total { background: linear-gradient(135deg, #667eea, #764ba2); }
        .stat-adherents { background: linear-gradient(135deg, #4CAF50, #45a049); }
        .stat-nonmembers { background: linear-gradient(135deg, #2196F3, #1976D2); }
        .stat-revenue { background: linear-gradient(135deg, #9C27B0, #7B1FA2); }

        .table-container {
            overflow-x: auto;
            margin: 20px 0;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        th {
            background: #f8f9fa;
            padding: 12px 8px;
            text-align: left;
            font-weight: 600;
            border-bottom: 2px solid #dee2e6;
            font-size: 0.9rem;
        }

        td {
            padding: 10px 8px;
            border-bottom: 1px solid #eee;
            vertical-align: middle;
            font-size: 0.9rem;
        }

        tr:nth-child(even) {
            background-color: #f8f9fa;
        }

        tr:hover {
            background-color: #e3f2fd;
        }

        .type-badge {
            padding: 4px 8px;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: 600;
            color: white;
            text-align: center;
            display: inline-block;
            min-width: 80px;
        }

        .type-adherent {
            background: linear-gradient(135deg, #4CAF50, #45a049);
        }

        .type-non-adherent {
            background: linear-gradient(135deg, #2196F3, #1976D2);
        }

        .status-badge {
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            color: white;
        }

        .status-paye { background: #4CAF50; }
        .status-pending { background: #ff9500; }
        .status-adherent { background: #2196F3; }

        .no-data {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .no-data h3 {
            margin-bottom: 10px;
            color: #999;
        }

        .debug-info {
            background: #f5f5f5;
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 10px;
            font-family: monospace;
            font-size: 0.8rem;
            margin-bottom: 20px;
        }

        .error-box {
            background: #ff6b6b;
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .success-box {
            background: #4CAF50;
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        /* ‚úÖ NIEUWE STYLES VOOR PAYMENT VALIDATION MODAL */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            margin-bottom: 25px;
            text-align: center;
        }

        .modal-header h3 {
            color: #333;
            margin-bottom: 10px;
            font-size: 1.5rem;
        }

        .modal-body {
            margin-bottom: 25px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .modal-footer {
            display: flex;
            gap: 15px;
            justify-content: flex-end;
        }

        .customer-info {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .customer-info h4 {
            color: #667eea;
            margin-bottom: 10px;
        }

        .customer-info p {
            margin: 5px 0;
            color: #666;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @media (max-width: 1200px) {
            .main-content {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .modal-content {
                padding: 20px;
                margin: 20px;
            }

            .modal-footer {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìä Administration - Pr√©sences du jour</h1>
            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p>Chargement de l'interface...</p>
            </div>
        </div>

        <div id="content" style="display: none;">
            <div class="main-content">
                <div class="left-panel">
                    <div class="debug-info">
                        <strong>üîß Debug Info:</strong>
                        <div id="debug-info">Loading...</div>
                    </div>

                    <div class="date-selector">
                        <label>S√©lectionner une date:</label>
                        <input type="date" id="date-picker" />
                        <button class="btn btn-primary" onclick="loadToday()">Aujourd'hui</button>
                        <button class="btn btn-primary" onclick="loadSelectedDate()">Charger</button>
                        <button class="btn btn-warning" onclick="archiveToday()">üì¶ Archiver aujourd'hui</button>
                    </div>

                    <div id="error-display" style="display: none;" class="error-box">
                    </div>

                    <div id="success-display" style="display: none;" class="success-box">
                    </div>

                    <div class="stats-grid">
                        <div class="stat-card stat-total">
                            <h3 id="stat-total">0</h3>
                            <p>Total pr√©sences</p>
                        </div>
                        <div class="stat-card stat-adherents">
                            <h3 id="stat-adherents">0</h3>
                            <p>Adh√©rents</p>
                        </div>
                        <div class="stat-card stat-nonmembers">
                            <h3 id="stat-nonmembers">0</h3>
                            <p>Non-adh√©rents</p>
                        </div>
                        <div class="stat-card stat-revenue">
                            <h3 id="stat-revenue">0</h3>
                            <p>Recettes (‚Ç¨)</p>
                        </div>
                    </div>

                    <div class="table-container">
                        <div id="table-loading" class="loading" style="display: none;">
                            <div class="spinner"></div>
                            <p>Chargement des donn√©es...</p>
                        </div>

                        <table id="presences-table" style="display: none;">
                            <thead>
                                <tr>
                                    <th>Date/Heure</th>
                                    <th>Type</th>
                                    <th>Nom</th>
                                    <th>Pr√©nom</th>
                                    <th>Niveau</th>
                                    <th>Tarif</th>
                                    <th>Paiement</th>
                                    <th>Statut</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="presences-tbody">
                            </tbody>
                        </table>

                        <div id="no-data" class="no-data" style="display: none;">
                            <h3>Aucune pr√©sence pour cette date</h3>
                            <p>Les pr√©sences appara√Ætront ici au fur et √† mesure des arriv√©es.</p>
                        </div>
                    </div>

                    <div style="margin-top: 20px; padding: 15px; background: rgba(227, 242, 253, 0.8); border-radius: 10px; display: flex; align-items: center; gap: 10px;">
                        <span style="font-size: 1.2rem;">üîÑ</span>
                        <span>Actualisation automatique toutes les 30 secondes</span>
                    </div>
                </div>

                <div class="right-panel">
                    <div class="panel">
                        <h4>üèîÔ∏è Export Saison Actuelle</h4>
                        <button class="btn btn-success" onclick="exportSeason()" style="width: 100%; margin: 10px 0;">
                            üìä Exporter Saison Courante
                        </button>
                        <p style="font-size: 0.9rem; color: #666;">
                            Export automatique: 30 juin √† minuit
                        </p>
                    </div>

                    <div class="panel">
                        <h4>üìä Export Excel Historique</h4>
                        <select id="year-select" style="width: 100%; padding: 8px; margin: 10px 0;">
                            <option value="">S√©lectionner une ann√©e...</option>
                        </select>
                        <div style="display: flex; gap: 10px;">
                            <button class="btn btn-primary" onclick="exportYear()" style="flex: 1;">
                                üì• Exporter
                            </button>
                            <button class="btn btn-danger" onclick="exportAndCleanup()" style="flex: 1;">
                                üóëÔ∏è Export & Cleanup
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ‚úÖ NIEUWE PAYMENT VALIDATION MODAL -->
    <div id="validation-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>üí≥ Validation du paiement</h3>
            </div>

            <div class="modal-body">
                <div id="customer-info" class="customer-info">
                    <!-- Customer info will be populated by JavaScript -->
                </div>

                <div class="form-group">
                    <label for="validation-amount">Montant (‚Ç¨)</label>
                    <input type="number" id="validation-amount" step="0.01" min="0" placeholder="0.00">
                </div>

                <div class="form-group">
                    <label for="validation-method">M√©thode de paiement</label>
                    <select id="validation-method">
                        <option value="">S√©lectionner une m√©thode...</option>
                        <option value="Especes">üíµ Esp√®ces</option>
                        <option value="CB">üí≥ Carte bancaire (CB)</option>
                        <option value="Cheque">üìù Ch√®que</option>
                    </select>
                </div>
            </div>

            <div class="modal-footer">
                <button class="btn btn-primary" onclick="closeValidationModal()">
                    Annuler
                </button>
                <button class="btn btn-success" onclick="confirmValidation()">
                    ‚úÖ Valider le paiement
                </button>
            </div>
        </div>
    </div>

    <script>
        // ‚úÖ DEFINITIEVE API CONFIGURATIE
        const API_BASE_URL = 'http://localhost:3001';

        let isHistoricalMode = false;
        let currentDate = '';
        let currentValidationPresence = null; // ‚úÖ NOUVEAU: Pour modal state

        // Utility functions
        function showError(message) {
            const errorDiv = document.getElementById('error-display');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            setTimeout(() => {
                errorDiv.style.display = 'none';
            }, 5000);
        }

        function showSuccess(message) {
            const successDiv = document.getElementById('success-display');
            successDiv.textContent = message;
            successDiv.style.display = 'block';
            setTimeout(() => {
                successDiv.style.display = 'none';
            }, 3000);
        }

        function updateDebugInfo() {
            const debugInfo = document.getElementById('debug-info');
            debugInfo.innerHTML = `
                API URL: ${API_BASE_URL}<br>
                Current Date: ${currentDate}<br>
                Historical Mode: ${isHistoricalMode ? 'Yes' : 'No'}<br>
                Last Update: ${new Date().toLocaleTimeString()}
            `;
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ ENHANCED ADMIN INTERFACE STARTING UP');
            console.log('API Base URL:', API_BASE_URL);

            const today = new Date().toISOString().split('T')[0];
            document.getElementById('date-picker').value = today;
            currentDate = today;

            loadToday();
            loadAvailableYears();

            // Auto refresh every 30 seconds for current day only
            setInterval(() => {
                if (!isHistoricalMode) {
                    console.log('üîÑ Auto refresh...');
                    loadPresences();
                }
            }, 30000);

            updateDebugInfo();
        });

        async function loadToday() {
            console.log('üìÖ Loading today');
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('date-picker').value = today;
            currentDate = today;
            isHistoricalMode = false;

            await loadPresences();
            updateDebugInfo();
        }

        async function loadSelectedDate() {
            const selectedDate = document.getElementById('date-picker').value;
            if (!selectedDate) {
                showError('Veuillez s√©lectionner une date');
                return;
            }

            console.log('üìÖ Loading selected date:', selectedDate);
            currentDate = selectedDate;
            const today = new Date().toISOString().split('T')[0];
            isHistoricalMode = selectedDate !== today;

            await loadPresences();
            updateDebugInfo();
        }

        async function loadPresences() {
            console.log('üìã Loading presences for:', currentDate);
            showTableLoading();

            try {
                let response;
                let url;

                if (isHistoricalMode) {
                    url = `${API_BASE_URL}/presences/history/${currentDate}`;
                } else {
                    url = `${API_BASE_URL}/presences`;
                }

                console.log('üåê API Call:', url);
                response = await fetch(url);

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                console.log('üìã API Response:', data);

                if (data.success) {
                    let presences = data.presences || [];

                    // Filter for current date if viewing today
                    if (!isHistoricalMode) {
                        presences = presences.filter(p => 
                            p.date && p.date.startsWith(currentDate)
                        );
                        console.log(`üìã Filtered to ${presences.length} presences for today`);
                    }

                    displayPresences(presences);
                    updateStats(presences);
                } else {
                    console.error('‚ùå API Error:', data.error);
                    showError(data.error || 'Erreur lors du chargement');
                    displayPresences([]);
                }

                hideTableLoading();

            } catch (error) {
                console.error('üí• Network Error:', error);
                hideTableLoading();
                showError(`Erreur de connexion: ${error.message}`);
                displayPresences([]);
            }
        }

        function showTableLoading() {
            document.getElementById('table-loading').style.display = 'block';
            document.getElementById('presences-table').style.display = 'none';
            document.getElementById('no-data').style.display = 'none';
        }

        function hideTableLoading() {
            document.getElementById('table-loading').style.display = 'none';
        }

        function displayPresences(presences) {
            const tbody = document.getElementById('presences-tbody');
            const table = document.getElementById('presences-table');
            const noData = document.getElementById('no-data');

            tbody.innerHTML = '';

            if (presences.length === 0) {
                table.style.display = 'none';
                noData.style.display = 'block';
                return;
            }

            table.style.display = 'table';
            noData.style.display = 'none';

            // Sort presences by date (newest first)
            presences.sort((a, b) => new Date(b.date) - new Date(a.date));

            presences.forEach(presence => {
                const row = document.createElement('tr');

                const formatDateTime = (dateString) => {
                    if (!dateString) return '-';
                    const date = new Date(dateString);
                    return date.toLocaleString('fr-FR', {
                        day: '2-digit',
                        month: '2-digit',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                };

                const getTypeBadge = (type) => {
                    return type === 'adherent' 
                        ? '<span class="type-badge type-adherent">üë§ Adh√©rent</span>'
                        : '<span class="type-badge type-non-adherent">üéØ Visiteur</span>';
                };

                const getStatusBadge = (status) => {
                    const statusClass = status === 'Pay√©' ? 'status-paye' 
                        : status === 'adherent' ? 'status-adherent' 
                        : 'status-pending';
                    return `<span class="status-badge ${statusClass}">${status || 'En attente'}</span>`;
                };

                const getTarif = (presence) => {
                    if (presence.tarif !== undefined) {
                        return presence.tarif === 0 ? 'Gratuit' : `${presence.tarif}‚Ç¨`;
                    }
                    return '-';
                };

                const getActions = (presence) => {
                    if (isHistoricalMode) {
                        return '<em>Mode historique</em>';
                    }

                    let actions = '';
                    if (presence.status !== 'Pay√©' && presence.type === 'non-adherent') {
                        // ‚úÖ NOUVEAU: JSON.stringify pour veilige data passing
                        const presenceJson = JSON.stringify(presence).replace(/"/g, '&quot;');
                        actions += `<button class="btn btn-success btn-small" onclick="openValidationModal('${presence.id}', ${presenceJson})">‚úì Valider</button> `;
                    }
                    actions += `<button class="btn btn-danger btn-small" onclick="deletePresence('${presence.id}')">üóëÔ∏è</button>`;
                    return actions;
                };

                row.innerHTML = `
                    <td>${formatDateTime(presence.date)}</td>
                    <td>${getTypeBadge(presence.type)}</td>
                    <td><strong>${presence.nom || ''}</strong></td>
                    <td>${presence.prenom || ''}</td>
                    <td>${presence.niveau || '-'}</td>
                    <td>${getTarif(presence)}</td>
                    <td>${presence.methodePaiement || '-'}</td>
                    <td>${getStatusBadge(presence.status)}</td>
                    <td>${getActions(presence)}</td>
                `;

                tbody.appendChild(row);
            });
        }

        function updateStats(presences) {
            const totalPresences = presences.length;
            const adherents = presences.filter(p => p.type === 'adherent').length;
            const nonAdherents = presences.filter(p => p.type === 'non-adherent').length;
            const revenue = presences
                .filter(p => p.tarif && typeof p.tarif === 'number')
                .reduce((sum, p) => sum + p.tarif, 0);

            document.getElementById('stat-total').textContent = totalPresences;
            document.getElementById('stat-adherents').textContent = adherents;
            document.getElementById('stat-nonmembers').textContent = nonAdherents;
            document.getElementById('stat-revenue').textContent = revenue;
        }

        // ‚úÖ NIEUWE ENHANCED VALIDATION MODAL FUNCTIONS
        function openValidationModal(presenceId, presenceData) {
            console.log('üí≥ Opening validation modal for:', presenceId);
            console.log('Presence data:', presenceData);

            currentValidationPresence = presenceData;

            // Populate customer info
            const customerInfo = document.getElementById('customer-info');
            const formatDate = (dateString) => {
                if (!dateString) return '-';
                return new Date(dateString).toLocaleString('fr-FR', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            };

            const getAge = (dateNaissance) => {
                if (!dateNaissance) return 'Non sp√©cifi√©';
                const today = new Date();
                const birth = new Date(dateNaissance);
                let age = today.getFullYear() - birth.getFullYear();
                const monthDiff = today.getMonth() - birth.getMonth();
                if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birth.getDate())) {
                    age--;
                }
                return `${age} ans`;
            };

            customerInfo.innerHTML = `
                <h4>üë§ Information du client</h4>
                <p><strong>Nom :</strong> ${presenceData.nom} ${presenceData.prenom}</p>
                <p><strong>Date d'arriv√©e :</strong> ${formatDate(presenceData.date)}</p>
                <p><strong>Niveau :</strong> ${presenceData.niveau || 'Non sp√©cifi√©'}</p>
                <p><strong>√Çge :</strong> ${getAge(presenceData.dateNaissance)}</p>
                ${presenceData.email ? `<p><strong>Email :</strong> ${presenceData.email}</p>` : ''}
                ${presenceData.telephone ? `<p><strong>T√©l√©phone :</strong> ${presenceData.telephone}</p>` : ''}
            `;

            // ‚úÖ PRE-FILL AMOUNT FROM PRESENCE DATA
            const amountField = document.getElementById('validation-amount');
            if (presenceData.tarif !== undefined) {
                amountField.value = presenceData.tarif;
            } else {
                amountField.value = '10'; // Default amount
            }

            // ‚úÖ PRE-SELECT PAYMENT METHOD IF AVAILABLE
            const methodField = document.getElementById('validation-method');
            if (presenceData.methodePaiement) {
                methodField.value = presenceData.methodePaiement;
            } else {
                methodField.value = 'Especes'; // Default to cash
            }

            // Show modal
            document.getElementById('validation-modal').style.display = 'flex';
        }

        function closeValidationModal() {
            document.getElementById('validation-modal').style.display = 'none';
            currentValidationPresence = null;
        }

        async function confirmValidation() {
            if (!currentValidationPresence) {
                showError('Erreur: Aucune pr√©sence s√©lectionn√©e');
                return;
            }

            const amount = document.getElementById('validation-amount').value;
            const method = document.getElementById('validation-method').value;

            if (!amount || amount < 0) {
                showError('Veuillez entrer un montant valide');
                return;
            }

            if (!method) {
                showError('Veuillez s√©lectionner une m√©thode de paiement');
                return;
            }

            console.log(`üí≥ Confirming validation for presence ${currentValidationPresence.id}`);
            console.log('Amount:', amount, 'Method:', method);

            try {
                const response = await fetch(`${API_BASE_URL}/presences/${currentValidationPresence.id}/valider`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        montant: parseFloat(amount),
                        methodePaiement: method
                    })
                });

                const result = await response.json();
                console.log('üí≥ Validation result:', result);

                if (result.success) {
                    showSuccess(`Paiement valid√©: ${amount}‚Ç¨ par ${method}`);
                    closeValidationModal();
                    await loadPresences();
                } else {
                    showError('Erreur: ' + result.error);
                }
            } catch (error) {
                console.error('üí• Validation error:', error);
                showError('Erreur de connexion');
            }
        }

        // ‚úÖ SIMPLIFIED DELETE FUNCTION (unchanged)
        async function deletePresence(id) {
            if (!confirm('√ätes-vous s√ªr de vouloir supprimer cette pr√©sence ?')) {
                return;
            }

            console.log(`üóëÔ∏è Deleting presence ${id}`);

            try {
                const response = await fetch(`${API_BASE_URL}/presences/${id}`, {
                    method: 'DELETE'
                });

                const result = await response.json();
                console.log('üóëÔ∏è Delete result:', result);

                if (result.success) {
                    showSuccess('Pr√©sence supprim√©e');
                    await loadPresences();
                } else {
                    showError('Erreur: ' + result.error);
                }
            } catch (error) {
                console.error('üí• Delete error:', error);
                showError('Erreur de connexion');
            }
        }

        async function archiveToday() {
            if (!confirm('Archiver toutes les pr√©sences d\'aujourd\'hui et les effacer de la liste courante ?')) {
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/presences/archive`, {
                    method: 'POST'
                });

                const result = await response.json();
                if (result.success) {
                    showSuccess(result.message);
                    await loadPresences();
                } else {
                    showError('Erreur: ' + (result.error || result.message));
                }
            } catch (error) {
                console.error('üí• Archive error:', error);
                showError('Erreur de connexion');
            }
        }

        async function loadAvailableYears() {
            try {
                const response = await fetch(`${API_BASE_URL}/admin/export/years`);
                const result = await response.json();

                if (result.success) {
                    const select = document.getElementById('year-select');
                    select.innerHTML = '<option value="">S√©lectionner une ann√©e...</option>';

                    result.years.forEach(year => {
                        const option = document.createElement('option');
                        option.value = year;
                        option.textContent = year;
                        select.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('üí• Load years error:', error);
            }
        }

        async function exportSeason() {
            try {
                const response = await fetch(`${API_BASE_URL}/admin/export/season`, {
                    method: 'POST'
                });

                const result = await response.json();
                if (result.success) {
                    showSuccess(`Export r√©ussi: ${result.filename}\nRecords: ${result.recordCount}`);
                } else {
                    showError('Erreur: ' + result.error);
                }
            } catch (error) {
                console.error('üí• Season export error:', error);
                showError('Erreur de connexion');
            }
        }

        async function exportYear() {
            const year = document.getElementById('year-select').value;
            if (!year) {
                showError('Veuillez s√©lectionner une ann√©e');
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/admin/export/${year}`, {
                    method: 'POST'
                });

                const result = await response.json();
                if (result.success) {
                    showSuccess(`Export r√©ussi: ${result.filename}\nRecords: ${result.recordCount}`);
                } else {
                    showError('Erreur: ' + result.error);
                }
            } catch (error) {
                console.error('üí• Year export error:', error);
                showError('Erreur de connexion');
            }
        }

        // ‚úÖ KEYBOARD SHORTCUTS FOR MODAL
        document.addEventListener('keydown', function(event) {
            if (document.getElementById('validation-modal').style.display === 'flex') {
                if (event.key === 'Escape') {
                    closeValidationModal();
                } else if (event.key === 'Enter' && event.ctrlKey) {
                    confirmValidation();
                }
            }
        });

        // Hide loading and show content when page is ready
        setTimeout(() => {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('content').style.display = 'block';
        }, 1000);
    </script>
</body>
</html>
