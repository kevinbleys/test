<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üìä Administration - Pr√©sences du jour</title>
    <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container { max-width: 1400px; margin: 0 auto; }
        .header {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .header h1 { margin: 0; color: #333; font-size: 24px; }
        .info-box {
            background: white;
            border-left: 4px solid #667eea;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            font-size: 13px;
            color: #666;
            font-family: 'Courier New', monospace;
            line-height: 1.6;
        }
        .date-selector {
            background: white;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }
        .date-selector input[type="date"], .date-selector select {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }
        .date-selector button {
            padding: 8px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            transition: all 0.3s;
        }
        .btn-today { background: #3b82f6; color: white; }
        .btn-today:hover { background: #2563eb; }
        .btn-load { background: #10b981; color: white; }
        .btn-load:hover { background: #059669; }
        .btn-archive { background: #f59e0b; color: white; }
        .btn-archive:hover { background: #d97706; }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        .stat-card {
            border-radius: 12px;
            padding: 20px;
            color: white;
            font-weight: 600;
        }
        .stat-card.total { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .stat-card.adherents { background: linear-gradient(135deg, #f472b6 0%, #ec4899 100%); }
        .stat-card.non-adherents { background: linear-gradient(135deg, #22d3ee 0%, #06b6d4 100%); }
        .stat-card.revenue { background: linear-gradient(135deg, #4ade80 0%, #22c55e 100%); }
        .stat-label { font-size: 13px; opacity: 0.9; margin-bottom: 10px; }
        .stat-value { font-size: 36px; font-weight: 700; }
        .vente-libre-section {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .vente-libre-section h3 { margin: 0 0 15px 0; color: #333; font-size: 16px; }
        .vente-form {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr auto;
            gap: 12px;
            align-items: end;
        }
        .form-group { display: flex; flex-direction: column; }
        .form-group label {
            font-size: 12px;
            color: #666;
            margin-bottom: 5px;
            font-weight: 500;
        }
        .form-group input, .form-group select {
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }
        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        .btn-add-product {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 10px 24px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            height: 42px;
            transition: all 0.3s;
        }
        .btn-add-product:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        .export-section {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .export-section h3 { margin: 0 0 15px 0; color: #333; font-size: 16px; }
        .export-section-info {
            background: #fef3c7;
            border-left: 4px solid #f59e0b;
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 15px;
            font-size: 13px;
            color: #92400e;
            font-weight: 500;
        }
        .btn-export {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            transition: all 0.3s;
        }
        .btn-export:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        .export-season-section {
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 10px;
        }
        .export-season-section select {
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            width: 100%;
        }
        .export-season-section button { width: 100%; grid-column: 1 / -1; }
        .table-section {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            overflow-x: auto;
        }
        table { width: 100%; border-collapse: collapse; }
        thead { background: #f9fafb; border-bottom: 2px solid #e5e7eb; }
        th {
            padding: 12px;
            text-align: left;
            font-weight: 600;
            color: #374151;
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        td { padding: 12px; border-bottom: 1px solid #f0f0f0; }
        tr:hover { background: #f9fafb; }
        .badge {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 16px;
            font-size: 12px;
            font-weight: 600;
        }
        .badge.adherent { background: #dbeafe; color: #1e40af; }
        .badge.non-adherent { background: #fef3c7; color: #b45309; }
        .badge.vente { background: linear-gradient(135deg, #fef08a 0%, #fbbf24 100%); color: #92400e; font-weight: bold; }
        .badge.tentative { background: #fee2e2; color: #991b1b; font-weight: bold; }
        .price { font-weight: 700; color: #10b981; }
        .btn-validate {
            background: #3b82f6;
            color: white;
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
        }
        .btn-validate:hover { background: #2563eb; }
        .btn-delete {
            background: #ef4444;
            color: white;
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        .btn-delete:hover { background: #dc2626; }
        .status-text {
            background: #dcfce7;
            color: #166534;
            padding: 6px 12px;
            border-radius: 16px;
            font-size: 12px;
            font-weight: 600;
            display: inline-block;
        }
        .status-text.tentative { background: #fee2e2; color: #991b1b; }
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            align-items: center;
            justify-content: center;
        }
        .modal.show { display: flex; }
        .modal-content {
            background-color: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            max-width: 400px;
            width: 90%;
        }
        .modal-content h2 { margin: 0 0 20px 0; color: #333; }
        .modal-form { display: flex; flex-direction: column; gap: 15px; }
        .modal-form label { font-size: 14px; color: #666; font-weight: 500; }
        .modal-form input, .modal-form select {
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 14px;
        }
        .modal-form input:focus, .modal-form select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        .modal-buttons { display: flex; gap: 12px; justify-content: flex-end; margin-top: 20px; }
        .modal-buttons button { padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; }
        .modal-buttons .btn-cancel { background: #e5e7eb; color: #374151; }
        .modal-buttons .btn-submit { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        @media (max-width: 768px) {
            .vente-form { grid-template-columns: 1fr; }
            .stats { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header"><h1>üìä Administration - Pr√©sences du jour</h1></div>
        <div class="info-box">
            API URL: http://localhost:3001<br>
            Current Date: <span id="currentDate"></span><br>
            Selected: <span id="selectedDate"></span><br>
            Historical Mode: <span id="historicalMode">No</span><br>
            Last Update: <span id="lastUpdate">14:22:25</span><br>
            Status: Loaded <span id="presenceCount">0</span> presences (live)
        </div>
        <div class="date-selector">
            <input type="date" id="dateInput" />
            <button class="btn-today" onclick="selectToday()">Aujourd'hui</button>
            <button class="btn-load" onclick="loadPresences()">Charger</button>
            <button class="btn-archive" onclick="archivePresences()">üìÅ Archiver</button>
        </div>
        <div class="stats">
            <div class="stat-card total"><div class="stat-label">Total pr√©sences</div><div class="stat-value" id="statTotal">0</div></div>
            <div class="stat-card adherents"><div class="stat-label">Adh√©rents</div><div class="stat-value" id="statAdherents">0</div></div>
            <div class="stat-card non-adherents"><div class="stat-label">Non-adh√©rents</div><div class="stat-value" id="statNonAdherents">0</div></div>
            <div class="stat-card revenue"><div class="stat-label">Recettes (‚Ç¨)</div><div class="stat-value" id="statRevenue">0.00</div></div>
        </div>
        <div class="vente-libre-section">
            <h3>üõçÔ∏è Vente Libre</h3>
            <div class="vente-form">
                <div class="form-group"><label>Produit</label><input type="text" id="productName" placeholder="Ex: T-shirt, Baudrier..." /></div>
                <div class="form-group"><label>Prix (‚Ç¨)</label><input type="number" id="productPrice" placeholder="0.00" step="0.01" min="0" /></div>
                <div class="form-group"><label>Paiement</label><select id="productPayment"><option value="Especes">Esp√®ces</option><option value="CB">CB</option><option value="Cheque">Ch√®que</option></select></div>
                <button class="btn-add-product" onclick="addProductSale()">Ajouter</button>
            </div>
        </div>
        <div class="export-section">
            <h3>üìä Export Saison</h3>
            <div class="export-section-info">‚úÖ Exporte toutes les donn√©es du club pour la saison s√©lectionn√©e (1 sept - 31 ao√ªt). Les saisons affich√©es sont uniquement celles avec des donn√©es.</div>
            <div class="export-season-section">
                <select id="seasonSelect"><option value="">S√©lectionner une saison...</option></select>
                <button class="btn-export" onclick="exportSeason()">üìä Exporter Saison</button>
            </div>
        </div>
        <div class="table-section">
            <table>
                <thead><tr><th>DATE/HEURE</th><th>TYPE</th><th>NOM</th><th>PR√âNOM</th><th>NIVEAU</th><th>TARIF</th><th>PAIEMENT</th><th>STATUT</th><th>ACTIONS</th></tr></thead>
                <tbody id="presencesTableBody"></tbody>
            </table>
        </div>
    </div>
    <div id="validationModal" class="modal">
        <div class="modal-content">
            <h2>üí∞ Valider le paiement</h2>
            <div class="modal-form">
                <label>Montant (‚Ç¨)</label><input type="number" id="validationMontant" placeholder="10.00" step="0.01" min="0" />
                <label>M√©thode de paiement</label><select id="validationMethode"><option value="Especes">Esp√®ces</option><option value="CB">CB</option><option value="Cheque">Ch√®que</option></select>
                <div class="modal-buttons">
                    <button class="btn-cancel" onclick="closeValidationModal()">Annuler</button>
                    <button class="btn-submit" onclick="submitValidation()">Valider</button>
                </div>
            </div>
        </div>
    </div>
    <script>
const API_URL = 'http://localhost:3001';
let validationPresenceId = null;
let currentMode = 'today';
let currentHistoryDate = null;

document.addEventListener('DOMContentLoaded', async () => {
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('dateInput').value = today;
    document.getElementById('currentDate').textContent = today;
    document.getElementById('selectedDate').textContent = today;
    loadPresences();
    await loadSeasons();
    setInterval(() => {
        const now = new Date();
        document.getElementById('lastUpdate').textContent = String(now.getHours()).padStart(2, '0') + ':' + String(now.getMinutes()).padStart(2, '0') + ':' + String(now.getSeconds()).padStart(2, '0');
    }, 1000);
    document.getElementById('dateInput').addEventListener('change', function() {
        currentHistoryDate = this.value;
        currentMode = 'history';
        loadPresences();
    });
});

async function loadPresences() {
    try {
        const dateInput = document.getElementById('dateInput').value;
        let url = currentMode === 'history' && currentHistoryDate ? `${API_URL}/presences/history/${currentHistoryDate}` : `${API_URL}/presences`;
        document.getElementById('historicalMode').textContent = currentMode === 'history' ? 'Yes' : 'No';
        const response = await fetch(url);
        if (!response.ok) throw new Error('Failed to load');
        const data = await response.json();
        const presences = data.presences || [];
        renderPresences(presences);
        updateStats(presences);
        document.getElementById('presenceCount').textContent = presences.length;
        document.getElementById('selectedDate').textContent = dateInput;
    } catch (error) {
        console.error('Error:', error);
    }
}

function renderPresences(presences) {
    const tbody = document.getElementById('presencesTableBody');
    tbody.innerHTML = '';
    if (!presences || presences.length === 0) {
        tbody.innerHTML = '<tr><td colspan="9" style="text-align:center;color:#999;">Aucune pr√©sence</td></tr>';
        return;
    }
    presences.forEach(presence => {
        const row = document.createElement('tr');
        let badge = '', statusDisplay = '';
        if (presence.type === 'product-sale') badge = '<span class="badge vente">Vente</span>';
        else if (presence.type === 'adherent') badge = '<span class="badge adherent">Adh√©rent</span>';
        else if (presence.type === 'non-adherent') badge = '<span class="badge non-adherent">Non-adh√©rent</span>';
        else badge = '<span class="badge tentative">Tentative</span>';
        statusDisplay = presence.status === 'Pay√©' ? '<span class="status-text">pay√©</span>' : presence.type === 'non-adherent' ? `<button class="btn-validate" onclick="showValidationPopup('${presence.id}')">√Ä valider</button>` : '<span class="status-text tentative">' + (presence.status || 'N/A') + '</span>';
        row.innerHTML = `<td>${formatDate(presence.date)}</td><td>${badge}</td><td>${presence.nom || ''}</td><td>${presence.prenom || ''}</td><td>${presence.niveau || 'N/A'}</td><td class="price">${presence.tarif ? (presence.tarif || 0).toFixed(2) + '‚Ç¨' : '-'}</td><td>${presence.methodePaiement || 'N/A'}</td><td>${statusDisplay}</td><td><button class="btn-delete" onclick="deletePresence('${presence.id}')">üóëÔ∏è</button></td>`;
        tbody.appendChild(row);
    });
}

function updateStats(presences) {
    const total = presences.length;
    const adherents = presences.filter(p => p.type === 'adherent').length;
    const nonAdherents = presences.filter(p => p.type === 'non-adherent').length;
    const revenue = presences.reduce((sum, p) => sum + (p.tarif || 0), 0);
    document.getElementById('statTotal').textContent = total;
    document.getElementById('statAdherents').textContent = adherents;
    document.getElementById('statNonAdherents').textContent = nonAdherents;
    document.getElementById('statRevenue').textContent = revenue.toFixed(2);
}

async function addProductSale() {
    const productName = document.getElementById('productName').value.trim();
    const productPrice = parseFloat(document.getElementById('productPrice').value);
    const productPayment = document.getElementById('productPayment').value;
    if (!productName || isNaN(productPrice) || productPrice <= 0) { alert('Veuillez remplir tous les champs'); return; }
    try {
        const response = await fetch(`${API_URL}/presences`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ type: 'product-sale', nom: 'Vente', prenom: productName, tarif: productPrice, methodePaiement: productPayment, status: 'Pay√©' })
        });
        if (!response.ok) throw new Error('Failed');
        document.getElementById('productName').value = '';
        document.getElementById('productPrice').value = '';
        loadPresences();
    } catch (error) { alert('Erreur'); }
}

function showValidationPopup(presenceId) {
    validationPresenceId = presenceId;
    fetch(`${API_URL}/presences/${presenceId}`)
        .then(r => r.json())
        .then(data => {
            const presence = data.presence;
            document.getElementById('validationMontant').value = presence.tarif && presence.tarif > 0 ? presence.tarif.toFixed(2) : '10.00';
            document.getElementById('validationMethode').value = 'Especes';
            document.getElementById('validationModal').classList.add('show');
        })
        .catch(err => console.error('Error:', err));
}

function closeValidationModal() {
    document.getElementById('validationModal').classList.remove('show');
}

async function submitValidation() {
    const montant = parseFloat(document.getElementById('validationMontant').value);
    const methode = document.getElementById('validationMethode').value;
    if (isNaN(montant) || montant < 0) { alert('Montant invalide'); return; }
    try {
        const response = await fetch(`${API_URL}/presences/${validationPresenceId}/valider`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ montant, methodePaiement: methode })
        });
        if (!response.ok) throw new Error('Failed');
        closeValidationModal();
        loadPresences();
    } catch (error) { alert('Erreur'); }
}

async function deletePresence(presenceId) {
    if (!confirm('√ätes-vous s√ªr?')) return;
    try {
        const response = await fetch(`${API_URL}/presences/${presenceId}`, { method: 'DELETE' });
        if (!response.ok) throw new Error('Failed');
        loadPresences();
    } catch (error) { console.error('Error:', error); }
}

// üÜï LOAD ONLY SEASONS WITH ACTUAL DATA
async function loadSeasons() {
    try {
        const response = await fetch(`${API_URL}/admin/seasons`);
        const data = await response.json();
        
        if (!data.seasons || data.seasons.length === 0) {
            console.log('No seasons with data available');
            return;
        }
        
        const select = document.getElementById('seasonSelect');
        select.innerHTML = '<option value="">S√©lectionner une saison...</option>';
        
        // Sort by startYear descending (newest first)
        const seasons = data.seasons.sort((a, b) => b.startYear - a.startYear);
        
        seasons.forEach(season => {
            const option = document.createElement('option');
            option.value = JSON.stringify({ startYear: season.startYear, endYear: season.endYear });
            option.textContent = `Saison ${season.startYear}-${season.endYear}`;
            select.appendChild(option);
        });
        
        console.log(`‚úÖ Loaded ${seasons.length} seasons with data:`, seasons);
    } catch (error) { 
        console.error('Error loading seasons:', error); 
    }
}

async function exportSeason() {
    const seasonJson = document.getElementById('seasonSelect').value;
    if (!seasonJson) { alert('S√©lectionnez une saison'); return; }
    
    try {
        const season = JSON.parse(seasonJson);
        const startYear = season.startYear;
        const endYear = season.endYear;
        
        console.log(`[EXPORT SEASON] Exporting season ${startYear}-${endYear}...`);
        
        let allPresences = [];
        
        // Sept - Dec of start year
        for (let month = 9; month <= 12; month++) {
            const startDate = new Date(startYear, month - 1, 1);
            const endDate = new Date(startYear, month, 0);
            
            for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
                const dateStr = d.toISOString().split('T')[0];
                try {
                    const response = await fetch(`${API_URL}/presences/history/${dateStr}`);
                    const data = await response.json();
                    if (data.presences && data.presences.length > 0) {
                        allPresences = allPresences.concat(data.presences);
                    }
                } catch (e) { }
            }
        }
        
        // Jan - Aug of end year
        for (let month = 1; month <= 8; month++) {
            const startDate = new Date(endYear, month - 1, 1);
            const endDate = new Date(endYear, month, 0);
            
            for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
                const dateStr = d.toISOString().split('T')[0];
                try {
                    const response = await fetch(`${API_URL}/presences/history/${dateStr}`);
                    const data = await response.json();
                    if (data.presences && data.presences.length > 0) {
                        allPresences = allPresences.concat(data.presences);
                    }
                } catch (e) { }
            }
        }
        
        console.log(`[EXPORT SEASON] Total presences: ${allPresences.length}`);
        
        if (allPresences.length === 0) {
            alert(`Aucunes donn√©es √† exporter pour la saison ${startYear}-${endYear}`);
            return;
        }
        
        // Generate Excel
        const excelData = allPresences.map(p => ({
            'Date': formatDate(p.date), 'Heure': formatTime(p.date), 'Type': p.type === 'product-sale' ? 'Vente Libre' : (p.type === 'adherent' ? 'Adh√©rent' : 'Non-adh√©rent'),
            'Nom': p.nom || '', 'Pr√©nom': p.prenom, 'Niveau': p.niveau || 'N/A', 'Tarif': p.tarif || 0, 'Paiement': p.methodePaiement || 'N/A', 'Statut': p.status || p.type
        }));
        
        const ws = XLSX.utils.json_to_sheet(excelData);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, 'Presences');
        XLSX.writeFile(wb, `presences_saison_${startYear}-${endYear}.xlsx`);
        
        console.log(`[EXPORT SEASON] Success! Downloaded presences_saison_${startYear}-${endYear}.xlsx`);
    } catch (error) {
        console.error('[EXPORT SEASON] Error:', error);
        alert('Erreur lors de l\'export');
    }
}

function selectToday() {
    currentMode = 'today';
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('dateInput').value = today;
    loadPresences();
}

async function archivePresences() {
    if (!confirm('√ätes-vous s√ªr?')) return;
    try {
        const response = await fetch(`${API_URL}/presences/archive`, { method: 'POST' });
        if (!response.ok) throw new Error('Failed');
        alert('Archiv√©!');
        loadPresences();
        await loadSeasons();
    } catch (error) { alert('Erreur'); }
}

function formatDate(dateString) {
    const date = new Date(dateString);
    return date.toLocaleDateString('fr-FR');
}

function formatTime(dateString) {
    const date = new Date(dateString);
    return date.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
}

window.onclick = function(event) {
    const modal = document.getElementById('validationModal');
    if (event.target === modal) closeValidationModal();
}
    </script>
</body>
</html>