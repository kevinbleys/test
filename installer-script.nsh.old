; Custom NSIS installer script voor Klimzaal Presence Management
!include "MUI2.nsh"
!include "WinVer.nsh"

; Custom installer functies
!macro customInstall
  ; Installeer Node.js service dependencies
  SetOutPath "$INSTDIR\resources\app"
  
  ; Installeer node-windows voor service management
  ExecWait '"$INSTDIR\resources\app\node.exe" "$INSTDIR\resources\app\npm" install node-windows --save'
  
  ; Installeer en start de Windows service
  ExecWait '"$INSTDIR\resources\app\node.exe" "$INSTDIR\resources\app\install-service.js"'
  
  ; Maak desktop shortcut voor Admin Dashboard
  CreateShortcut "$DESKTOP\Klimzaal Admin Dashboard.lnk" "http://localhost:3001" "" "$INSTDIR\resources\app\assets\icon.ico" 0 SW_SHOWMAXIMIZED
  
  ; Maak desktop shortcut voor Tablet Interface  
  CreateShortcut "$DESKTOP\Klimzaal Tablet Interface.lnk" "http://localhost:3001/tablet" "" "$INSTDIR\resources\app\assets\tablet-icon.ico" 0 SW_SHOWMAXIMIZED
  
  ; Start Menu shortcuts
  CreateDirectory "$SMPROGRAMS\Klimzaal Presence Management"
  CreateShortcut "$SMPROGRAMS\Klimzaal Presence Management\Admin Dashboard.lnk" "http://localhost:3001" "" "$INSTDIR\resources\app\assets\icon.ico"
  CreateShortcut "$SMPROGRAMS\Klimzaal Presence Management\Tablet Interface.lnk" "http://localhost:3001/tablet" "" "$INSTDIR\resources\app\assets\tablet-icon.ico"
  CreateShortcut "$SMPROGRAMS\Klimzaal Presence Management\Uninstall.lnk" "$INSTDIR\uninstall.exe"
  
  ; Firewall regels toevoegen (optioneel)
  ; ExecWait 'netsh advfirewall firewall add rule name="Klimzaal Backend" dir=in action=allow protocol=TCP localport=3001'
!macroend

!macro customUnInstall
  ; Stop en verwijder Windows service
  ExecWait '"$INSTDIR\resources\app\node.exe" "$INSTDIR\resources\app\uninstall-service.js"'
  
  ; Verwijder desktop shortcuts
  Delete "$DESKTOP\Klimzaal Admin Dashboard.lnk"
  Delete "$DESKTOP\Klimzaal Tablet Interface.lnk"
  
  ; Verwijder Start Menu shortcuts
  RMDir /r "$SMPROGRAMS\Klimzaal Presence Management"
  
  ; Optioneel: firewall regel verwijderen
  ; ExecWait 'netsh advfirewall firewall delete rule name="Klimzaal Backend"'
!macroend

; Custom header voor installer venster
!macro customHeader
  !define MUI_WELCOMEPAGE_TEXT "Deze installer zal het Klimzaal Presence Management systeem installeren op uw computer.$\r$\n$\r$\nHet systeem bevat:$\r$\n• Backend service (automatisch gestart)$\r$\n• Admin dashboard interface$\r$\n• Tablet interface voor bezoekers$\r$\n$\r$\nKlik op Volgende om door te gaan."
  
  ; Custom finish page
  !define MUI_FINISHPAGE_TEXT "Klimzaal Presence Management is succesvol geïnstalleerd!$\r$\n$\r$\nDe backend service draait nu automatisch op de achtergrond.$\r$\n$\r$\nU kunt nu:$\r$\n• Admin Dashboard openen vanaf de desktop$\r$\n• Tablet Interface gebruiken voor bezoekers$\r$\n$\r$\nBij computerherstarts wordt de service automatisch gestart."
  !define MUI_FINISHPAGE_LINK "Open Admin Dashboard"
  !define MUI_FINISHPAGE_LINK_LOCATION "http://localhost:3001"
!macroend